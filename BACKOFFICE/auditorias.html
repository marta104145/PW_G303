<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Auditorias</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/auditorias.css">
  <script src="js/loadHeader.js" defer></script>
  <link rel="icon" type="image/png" href="images/logo.png">
  <script>
    function toggleDetails(el) {
      const row = el.closest('tr');
      row.classList.toggle('expanded');
    }
  </script>
</head>
<body>
  <div id="header-container"></div>
  <main style="padding-top: 80px">
    <section class="map-section">
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Procurar Auditoria">
      </div>

      <div class="box">
        <h2>Ocorrências Aceites</h2>
        <table id="ocorrenciasAceites" class="table">
          <thead>
            <tr>
              <th>Ocorrência</th>
              <th>Localização</th>
              <th>Utilizador</th>
              <th>Data</th>
              <th>Ação</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Ocorrência 1</td>
              <td>Lisboa</td>
              <td>João Silva</td>
              <td>2025-04-28</td>
              <td><button onclick="abrirFormulario(this)">Realizar Auditoria</button></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="box">
        <h2>Auditorias Realizadas</h2>
        <table id="auditoriasRealizadas" class="table">
          <thead>
            <tr>
              <th>Auditoria</th>
              <th>Localização</th>
              <th>Utilizador</th>
              <th>Data</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <!-- Auditorias serão inseridas aqui -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- Formulário modal -->
    <div id="modalFormulario">
      <form id="formAuditoria" class="formulario-auditoria">
        <h2>Nova Auditoria</h2>
      
        <label>Nome:</label>
        <input type="text" name="nome" required>
      
        <label>Origem:</label>
        <select name="origem" required>
          <option value="">-- Selecionar --</option>
          <option value="interna">Interna</option>
          <option value="externa">Externa</option>
        </select>
      
        <label>Descrição:</label>
        <textarea name="descricao" required></textarea>
      
        <label>Tipo:</label>
        <input type="text" name="tipo" required>
      
        <fieldset>
          <legend>Local Auditado</legend>
      
          <label>Rua</label>
          <input type="text" name="local_nome" required>
      
          <label>Código Postal</label>
          <input type="text" name="local_tipo" required>
        </fieldset>
      
        <label>Peritos Responsáveis:</label>
        <input type="text" name="equipa" required>
      
        <label>Materiais:</label>
        <div id="materiaisContainer"></div>
      
        <label>Data:</label>
        <input type="datetime-local" name="data" required>
      
        <label>Duração Estimada (em horas):</label>
        <input type="number" name="duracao" required>
      
        <div class="form-buttons">
          <button type="submit">Guardar Auditoria</button>
          <button type="button" onclick="fecharFormulario()">Cancelar</button>
        </div>
      </form>
    </div>

    <script>
      function abrirFormulario(btn) {
        document.getElementById('modalFormulario').style.display = 'flex';
        document.body.classList.add('modal-open');
        window.ocorrenciaClicada = btn.closest('tr');
        carregarMateriais();
      }

      function fecharFormulario() {
        document.getElementById('modalFormulario').style.display = 'none';
        document.body.classList.remove('modal-open');
        document.getElementById('formAuditoria').reset();
      }

      document.getElementById('formAuditoria').addEventListener('submit', function(e) {
        e.preventDefault();

        const dados = Object.fromEntries(new FormData(this));
        // Extrair materiais e quantidades
      const materiaisSelecionados = [];
      document.querySelectorAll('#materiaisContainer input[type="number"]').forEach(input => {
        const quantidade = parseInt(input.value);
        if (quantidade > 0) {
          materiaisSelecionados.push({
            nome: input.dataset.nome,
            quantidade
          });
        }
      });
      dados.materiais = materiaisSelecionados;
        dados.dataFormatada = new Date(dados.data).toLocaleString();

        const auditorias = JSON.parse(localStorage.getItem('auditorias')) || [];
        auditorias.push(dados);
        localStorage.setItem('auditorias', JSON.stringify(auditorias));

        adicionarAuditoriaNaTabela(dados);
        window.ocorrenciaClicada.remove();
        fecharFormulario();
      });

      function removerAuditoria(btn) {
        const detailsRow = btn.closest('tr');
        const mainRow = [...document.querySelectorAll('.audit-row')].find(
          row => row.nextElementSibling === detailsRow
        );
        if (mainRow && detailsRow) {
          mainRow.remove();
          detailsRow.remove();
        }
      }

      function editarAuditoria(btn) {
        const detailsRow = btn.closest('tr');
        const mainRow = [...document.querySelectorAll('.audit-row')].find(
          row => row.nextElementSibling === detailsRow
        );
        if (mainRow) {
          const nome = mainRow.querySelector('td').innerText;
          alert("Editar auditoria: " + nome);
        }
      }

      function adicionarAuditoriaNaTabela(dados) {
        const tbody = document.querySelector('#auditoriasRealizadas tbody');

        const linha = document.createElement('tr');
        linha.classList.add('audit-row');
        linha.innerHTML = `
          <td>${dados.nome}</td>
          <td>${dados.local_morada}</td>
          <td>${dados.equipa}</td>
          <td>${dados.dataFormatada}</td>
          <td onclick="toggleDetails(this)" class="expand-btn">▸</td>
        `;

        const detalhes = document.createElement('tr');
        detalhes.classList.add('details');
        detalhes.innerHTML = `
          <td colspan="5">
            <strong>Descrição:</strong><br>${dados.descricao}<br><br>
            <strong>Materiais e Equipamentos:</strong><br>
            <ul>
              ${dados.materiais.map(m => `<li>${m.nome}: ${m.quantidade}</li>`).join('')}
            </ul><br>
            <div class="actions">
             <button class="remove" onclick="removerAuditoria(this)">Remover</button>
             <button class="edit" onclick="editarAuditoria(this)">Editar</button>
           </div>
         </td>
        `;

        tbody.appendChild(linha);
        tbody.appendChild(detalhes);
      }

      document.addEventListener('DOMContentLoaded', () => {
        const guardadas = JSON.parse(localStorage.getItem('auditorias')) || [];
        guardadas.forEach(adicionarAuditoriaNaTabela);
      });

      function carregarMateriais() {
        const container = document.getElementById("materiaisContainer");
        const materiais = JSON.parse(localStorage.getItem("materiais")) || [];

        container.innerHTML = ""; // limpa anteriores

        materiais.forEach((material, index) => {
          const div = document.createElement("div");
          div.style.marginBottom = "10px";

          div.innerHTML = `
            <label style="font-weight: bold;">${material.nome} (${material.quantidade} disponíveis):</label>
            <input type="number" name="materiais[${index}].quantidade" 
                max="${material.quantidade}" min="0" value="0" 
                data-nome="${material.nome}" 
                placeholder="0" style="width: 60px; margin-left: 10px;">
            `;

        container.appendChild(div);
      });
      }
    </script>
  </main>
</body>
</html>